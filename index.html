<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>屁粮比价器</title>
<style>
:root{
--font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
--text:#222;
--muted:#666;
--bd:#e6e6e6;
--hd:#f7f7f7;
--accent:#2563eb;
--danger:#b91c1c;
--fs:13px;
--lh:1.45;
--cell-vpad:6px;
--cell-hpad:8px;
--input-pad:6px;
--radius:6px;
}
*{box-sizing:border-box}
body{margin:0;color:var(--text);font-family:var(--font);font-size:var(--fs);line-height:var(--lh);background:#fff}
header{max-width:1100px;margin:0 auto;padding:12px 16px 6px}
h1{margin:0 0 2px;font-size:15px;font-weight:600}
.sub{color:var(--muted);font-size:12px}
main{max-width:1100px;margin:0 auto;padding:0 16px 20px}
.toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:10px 0}
button{cursor:pointer;border:1px solid var(--bd);background:#fff;color:#111;border-radius:4px;padding:6px 10px;font-size:var(--fs)}
.btn-primary{border-color:#cfe0ff;color:#fff;background:#2b6de8}
.btn-danger{border-color:#f3d2d2;color:#fff;background:#dc2626}
.hint{color:var(--muted);font-size:12px;margin-left:auto}
.table-wrap{overflow:auto;border:1px solid var(--bd);border-radius:var(--radius)}
table{border-collapse:collapse;width:100%;min-width:900px;background:#fff}
th,td{border-bottom:1px solid var(--bd);padding:var(--cell-vpad) var(--cell-hpad);vertical-align:middle}
th{background:var(--hd);font-weight:600;color:#333;user-select:none}
th.sortable{cursor:pointer}
th.right, td.right{text-align:right}
.mono{font-variant-numeric: tabular-nums}
.chip{display:inline-block;padding:1px 6px;border-radius:5px;background:#eef2ff;color:#3730a3;font-size:12px}
input[type=text], input[type=number]{width:100%;padding:var(--input-pad) calc(var(--input-pad) + 2px);border:1px solid var(--bd);border-radius:4px;background:#fff;color:#111;font-size:var(--fs)}
input[type=number]{text-align:right}
.btn-del{border:1px solid #f3d2d2;color:var(--danger);background:#fff;padding:4px 8px;border-radius:4px}
</style>
</head>
<body>
<header>
<h1>屁粮比价器</h1>
<div class="sub">品牌、型号、片/包、包数、单价（¥/包）、总价（¥）、单片价格（¥/片）、备注。输入即计算；点击表头排序。</div>
</header>

<main>
<div class="toolbar">
<button class="btn-primary" id="addRowBtn">新增一行</button>
<button class="btn-danger" id="clearBtn">清空列表</button>
<span class="hint">总价 = 单价 × 包数；单片价格 = 单价 ÷ 片/包</span>
</div>

<div class="table-wrap">
<table id="tbl">
<thead>
<tr>
<th class="sortable" data-key="brand">品牌</th>
<th class="sortable" data-key="model">型号</th>
<th class="right sortable" data-key="ppp" style="width:90px">片/包</th>
<th class="right sortable" data-key="packs" style="width:90px">包数</th>
<th class="right sortable" data-key="unit" style="width:120px">单价（¥/包）</th>
<th class="right sortable" data-key="total" style="width:120px">总价（¥）</th>
<th class="right sortable" data-key="ppu" style="width:140px">单片价格（¥/片）</th>
<th>备注</th>
<th style="width:66px">操作</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>
</div>
</main>

<script>
(function(){
const $ = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);
const tbody = $('#tbody');

let sortKey = 'ppu';
let sortDir = 'asc';

function esc(s){ return (s||'').replace(/[<>&]/g, c=>({'<':'&lt;','>':'&gt;','&':'&amp;'}[c])); }
function toNum(v){ const n = parseFloat(v); return Number.isFinite(n)? n : 0; }
function toInt(v){ const n = Math.floor(parseFloat(v)); return Number.isFinite(n)? n : 0; }
function fmtMoney(n){ return Number.isFinite(n) ? n.toFixed(2) : '—'; }
function fmtUnit(n){ if(!Number.isFinite(n)) return '—'; return n.toFixed(4).replace(/0+$/,'').replace(/\.$/,''); }

function computeRow(tr){
const ppp = Math.max(0, toInt(tr.querySelector('input[name=ppp]').value));
const packs = Math.max(0, toInt(tr.querySelector('input[name=packs]').value));
const unit = Math.max(0, toNum(tr.querySelector('input[name=unit]').value));
const total = unit * packs;
const ppu = ppp > 0 ? (unit / ppp) : NaN;
tr.querySelector('.cell-total').textContent = '¥' + fmtMoney(total);
tr.querySelector('.cell-ppu').innerHTML = `<span class="chip">¥${fmtUnit(ppu)}</span>`;
tr.dataset.brand = (tr.querySelector('input[name=brand]').value || '').trim().toLowerCase();
tr.dataset.model = (tr.querySelector('input[name=model]').value || '').trim().toLowerCase();
tr.dataset.ppp = Number.isFinite(ppp) ? ppp : '';
tr.dataset.packs = Number.isFinite(packs) ? packs : '';
tr.dataset.unit = Number.isFinite(unit) ? unit : '';
tr.dataset.total = Number.isFinite(total) ? total : '';
tr.dataset.ppu = Number.isFinite(ppu) ? ppu : '';
}

function addRow(init={}){
const tr = document.createElement('tr');
tr.innerHTML = `
<td><input type="text" name="brand" placeholder="品牌" value="${esc(init.brand||'')}"></td>
<td><input type="text" name="model" placeholder="型号" value="${esc(init.model||'')}"></td>
<td class="right"><input type="number" name="ppp" min="1" step="1" placeholder="片/包" value="${Number.isFinite(init.ppp)? init.ppp : ''}"></td>
<td class="right"><input type="number" name="packs" min="1" step="1" placeholder="包数" value="${Number.isFinite(init.packs)? init.packs : ''}"></td>
<td class="right"><input type="number" name="unit" min="0" step="0.01" placeholder="¥/包" value="${Number.isFinite(init.unit)? init.unit : ''}"></td>
<td class="right mono cell-total">—</td>
<td class="right mono cell-ppu"><span class="chip">—</span></td>
<td><input type="text" name="note" placeholder="备注" value="${esc(init.note||'')}"></td>
<td><button type="button" class="btn-del">删除</button></td>
`;
tr.addEventListener('input', ()=> computeRow(tr));
tr.querySelector('.btn-del').addEventListener('click', ()=> tr.remove());
tr.addEventListener('keydown', (e)=>{
if(e.key === 'Enter'){
const inputs = Array.from(tr.querySelectorAll('input'));
const idx = inputs.indexOf(document.activeElement);
if(idx === inputs.length - 1){
e.preventDefault();
const r = addRow();
r.querySelector('input[name=brand]').focus();
}
}
});
tbody.appendChild(tr);
computeRow(tr);
return tr;
}

function compareRows(a, b, key){
if(key==='brand' || key==='model'){
const A = a.dataset[key] || '';
const B = b.dataset[key] || '';
return A.localeCompare(B, 'zh-Hans-CN');
}
const Araw = parseFloat(a.dataset[key]);
const Braw = parseFloat(b.dataset[key]);
const A = Number.isFinite(Araw) ? Araw : Number.POSITIVE_INFINITY;
const B = Number.isFinite(Braw) ? Braw : Number.POSITIVE_INFINITY;
return A - B;
}

function sortBy(key){
sortKey = key;
Array.from(tbody.querySelectorAll('tr')).forEach(tr=>computeRow(tr));
const rows = Array.from(tbody.querySelectorAll('tr'));
rows.sort((a,b)=>{
const r = compareRows(a,b,key);
return sortDir==='asc' ? r : -r;
});
rows.forEach(r=>tbody.appendChild(r));
updateHeaderIndicators();
}

function updateHeaderIndicators(){
$$('#tbl thead th.sortable').forEach(th=>{
const key = th.getAttribute('data-key');
const base = th.getAttribute('data-label') || th.textContent.replace(/\s+[▾▴]$/,'');
th.setAttribute('data-label', base);
if(key === sortKey){
th.textContent = base + ' ' + (sortDir==='asc' ? '▾' : '▴');
}else{
th.textContent = base;
}
});
}

$$('#tbl thead th.sortable').forEach(th=>{
th.addEventListener('click', ()=>{
const key = th.getAttribute('data-key');
if(sortKey === key){
sortDir = (sortDir==='asc' ? 'desc' : 'asc');
}else{
sortKey = key;
sortDir = 'asc';
}
sortBy(sortKey);
});
});

$('#addRowBtn').addEventListener('click', ()=>{
const r = addRow();
r.querySelector('input[name=brand]').focus();
});
$('#clearBtn').addEventListener('click', ()=>{
if(confirm('确定清空列表吗？')){
tbody.innerHTML = '';
addRow().querySelector('input[name=brand]').focus();
sortKey = 'ppu'; sortDir = 'asc'; updateHeaderIndicators();
}
});

addRow(); addRow(); addRow();
updateHeaderIndicators();
})();
</script>
</body>
</html>